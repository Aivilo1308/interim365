{% extends "base.html" %}
{% load static %}

{% block title %}Journal des Logs et Audits{% endblock %}

{% block extra_css %}
<style>
  /* En-tête avec stats */
  .logs-header {
    background: linear-gradient(135deg, var(--gray-800) 0%, var(--gray-700) 50%, var(--gray-600) 100%);
    color: white;
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
  }

  .logs-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at 20% 20%, rgba(255,255,255,0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(255,255,255,0.1) 0%, transparent 50%);
  }

  .logs-header-content {
    position: relative;
    z-index: 1;
  }

  .logs-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .logs-subtitle {
    font-size: 1rem;
    opacity: 0.9;
    margin-bottom: 1.5rem;
  }

  .logs-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
  }

  .logs-stat {
    text-align: center;
    padding: 1.25rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .logs-stat-value {
    font-size: 2rem;
    font-weight: 800;
  }

  .logs-stat-label {
    font-size: 0.85rem;
    opacity: 0.9;
    margin-top: 0.25rem;
  }

  /* Filtres */
  .filters-card {
    background: white;
    border-radius: 1rem;
    box-shadow: var(--shadow);
    margin-bottom: 1.5rem;
    overflow: hidden;
  }

  .filters-header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }

  .filters-header h3 {
    margin: 0;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .filters-toggle {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 0.5rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.3s;
  }

  .filters-toggle:hover {
    background: rgba(255,255,255,0.3);
  }

  .filters-body {
    padding: 1.5rem;
  }

  .filters-body.collapsed {
    display: none;
  }

  .filters-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
  }

  .filter-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
  }

  .filter-input,
  .filter-select {
    padding: 0.625rem 0.875rem;
    border: 2px solid var(--gray-200);
    border-radius: 0.5rem;
    font-size: 0.95rem;
    transition: all 0.3s;
  }

  .filter-input:focus,
  .filter-select:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  /* Date/Heure groupés */
  .datetime-group {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 0.5rem;
  }

  .datetime-group .filter-input {
    min-width: 0;
  }

  .time-input {
    width: 100px;
  }

  .filters-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--gray-200);
  }

  /* Boutons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    border: none;
    border-radius: 0.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
  }

  .btn-primary {
    background: var(--primary);
    color: white;
  }

  .btn-primary:hover {
    background: var(--primary-dark);
  }

  .btn-secondary {
    background: var(--gray-200);
    color: var(--gray-700);
  }

  .btn-secondary:hover {
    background: var(--gray-300);
  }

  .btn-success {
    background: var(--secondary);
    color: white;
  }

  .btn-outline {
    background: transparent;
    border: 2px solid var(--gray-300);
    color: var(--gray-700);
  }

  .btn-outline:hover {
    border-color: var(--primary);
    color: var(--primary);
  }

  .btn-sm {
    padding: 0.5rem 0.875rem;
    font-size: 0.85rem;
  }

  /* Tableau des logs */
  .logs-table-card {
    background: white;
    border-radius: 1rem;
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .logs-table-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .logs-table-header h3 {
    margin: 0;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .export-buttons {
    display: flex;
    gap: 0.5rem;
  }

  .logs-table-container {
    overflow-x: auto;
  }

  .logs-table {
    width: 100%;
    border-collapse: collapse;
  }

  .logs-table th {
    background: var(--gray-50);
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--gray-700);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--gray-200);
    white-space: nowrap;
  }

  .logs-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--gray-100);
    vertical-align: top;
  }

  .logs-table tr:hover {
    background: var(--gray-50);
  }

  .logs-table tr:last-child td {
    border-bottom: none;
  }

  /* Cellules spécifiques */
  .log-date {
    white-space: nowrap;
    font-size: 0.9rem;
  }

  .log-date .date {
    font-weight: 600;
    color: var(--gray-800);
  }

  .log-date .time {
    color: var(--gray-500);
    font-size: 0.85rem;
  }

  .log-action {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.8rem;
    font-weight: 600;
    white-space: nowrap;
  }

  .log-action.creation { background: #dbeafe; color: #1e40af; }
  .log-action.modification { background: #fef3c7; color: #92400e; }
  .log-action.validation { background: #dcfce7; color: #166534; }
  .log-action.proposition { background: #e0e7ff; color: #3730a3; }
  .log-action.annulation { background: #fee2e2; color: #991b1b; }
  .log-action.notification { background: #f3e8ff; color: #6b21a8; }
  .log-action.autre { background: var(--gray-200); color: var(--gray-700); }

  .log-user {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .log-user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--primary-light);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    font-weight: 600;
    font-size: 0.85rem;
    flex-shrink: 0;
  }

  .log-user-avatar.system {
    background: var(--gray-200);
    color: var(--gray-600);
  }

  .log-user-avatar.superuser {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: white;
  }

  .log-user-info {
    min-width: 0;
  }

  .log-user-name {
    font-weight: 600;
    color: var(--gray-800);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .log-user-matricule {
    font-size: 0.8rem;
    color: var(--gray-500);
  }

  .log-description {
    max-width: 300px;
    font-size: 0.9rem;
    color: var(--gray-600);
    line-height: 1.4;
  }

  .log-description.truncated {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .log-demande {
    font-family: monospace;
    font-size: 0.85rem;
    color: var(--primary);
    background: var(--primary-light);
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
  }

  .log-ip {
    font-family: monospace;
    font-size: 0.8rem;
    color: var(--gray-500);
  }

  .log-niveau {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    background: var(--gray-100);
    color: var(--gray-600);
  }

  .log-actions {
    display: flex;
    gap: 0.5rem;
  }

  .action-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 0.375rem;
    background: var(--gray-100);
    color: var(--gray-600);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .action-btn:hover {
    background: var(--primary-light);
    color: var(--primary);
  }

  /* Pagination */
  .pagination-container {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .pagination-info {
    font-size: 0.9rem;
    color: var(--gray-600);
  }

  .pagination {
    display: flex;
    gap: 0.25rem;
  }

  .pagination a,
  .pagination span {
    padding: 0.5rem 0.875rem;
    border: 1px solid var(--gray-200);
    border-radius: 0.375rem;
    text-decoration: none;
    color: var(--gray-700);
    font-size: 0.9rem;
    transition: all 0.2s;
  }

  .pagination a:hover {
    background: var(--primary-light);
    border-color: var(--primary);
    color: var(--primary);
  }

  .pagination .current {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
  }

  .pagination .disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 1rem;
  }

  .modal-overlay.active {
    display: flex;
  }

  .modal {
    background: white;
    border-radius: 1rem;
    max-width: 700px;
    width: 100%;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  .modal-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--gray-50);
  }

  .modal-header h3 {
    margin: 0;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray-500);
    padding: 0.25rem;
    line-height: 1;
  }

  .modal-close:hover {
    color: var(--gray-800);
  }

  .modal-body {
    padding: 1.5rem;
    overflow-y: auto;
    max-height: calc(90vh - 140px);
  }

  .detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .detail-item {
    padding: 0.75rem;
    background: var(--gray-50);
    border-radius: 0.5rem;
  }

  .detail-item.full {
    grid-column: 1 / -1;
  }

  .detail-label {
    font-size: 0.75rem;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
  }

  .detail-value {
    font-weight: 600;
    color: var(--gray-800);
    word-break: break-word;
  }

  .detail-value.code {
    font-family: monospace;
    font-size: 0.85rem;
    background: var(--gray-100);
    padding: 0.5rem;
    border-radius: 0.25rem;
    overflow-x: auto;
  }

  .json-preview {
    background: var(--gray-800);
    color: #10b981;
    padding: 1rem;
    border-radius: 0.5rem;
    font-family: monospace;
    font-size: 0.8rem;
    overflow-x: auto;
    max-height: 200px;
    overflow-y: auto;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--gray-500);
  }

  .empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .empty-state h3 {
    font-size: 1.25rem;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
  }

  /* Badges */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .badge-superuser {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: white;
  }

  .badge-info {
    background: #dbeafe;
    color: #1e40af;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .filters-row {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .detail-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .logs-header {
      padding: 1.5rem;
    }

    .logs-title {
      font-size: 1.5rem;
    }

    .logs-stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .filters-row {
      grid-template-columns: 1fr;
    }

    .datetime-group {
      grid-template-columns: 1fr;
    }

    .time-input {
      width: 100%;
    }

    .logs-table-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .pagination-container {
      flex-direction: column;
      align-items: center;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- En-tête avec statistiques -->
<div class="logs-header">
  <div class="logs-header-content">
    <h1 class="logs-title">
      <i class="fas fa-clipboard-list"></i>
      Journal des Logs et Audits
    </h1>
    <p class="logs-subtitle">
      Historique complet des actions et événements du système
    </p>
    
    <div class="logs-stats-grid">
      <div class="logs-stat">
        <div class="logs-stat-value">{{ stats.total|default:0 }}</div>
        <div class="logs-stat-label">Total des logs</div>
      </div>
      <div class="logs-stat">
        <div class="logs-stat-value">{{ stats.aujourd_hui|default:0 }}</div>
        <div class="logs-stat-label">Aujourd'hui</div>
      </div>
      <div class="logs-stat">
        <div class="logs-stat-value">{{ stats.cette_semaine|default:0 }}</div>
        <div class="logs-stat-label">Cette semaine</div>
      </div>
      <div class="logs-stat">
        <div class="logs-stat-value">{{ stats.filtres_actifs|default:0 }}</div>
        <div class="logs-stat-label">Résultats filtrés</div>
      </div>
    </div>
  </div>
</div>

<!-- Filtres -->
<div class="filters-card">
  <div class="filters-header" onclick="toggleFilters()">
    <h3><i class="fas fa-filter"></i> Filtres avancés</h3>
    <button type="button" class="filters-toggle" id="filtersToggleBtn">
      <i class="fas fa-chevron-down" id="filtersIcon"></i>
    </button>
  </div>
  
  <form method="GET" action="{% url 'journal_logs' %}" id="filtersForm">
    <div class="filters-body" id="filtersBody">
      <!-- Ligne 1: Plage de dates -->
      <div class="filters-row">
        <div class="filter-group">
          <label class="filter-label">Date de début</label>
          <div class="datetime-group">
            <input type="date" name="date_debut" class="filter-input" 
                   value="{{ date_debut }}" placeholder="Date début">
            <input type="time" name="heure_debut" class="filter-input time-input" 
                   value="{{ heure_debut|default:'00:00' }}">
          </div>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Date de fin</label>
          <div class="datetime-group">
            <input type="date" name="date_fin" class="filter-input" 
                   value="{{ date_fin }}" placeholder="Date fin">
            <input type="time" name="heure_fin" class="filter-input time-input" 
                   value="{{ heure_fin|default:'23:59' }}">
          </div>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Raccourcis</label>
          <select class="filter-select" onchange="setDateRange(this.value)">
            <option value="">-- Période --</option>
            <option value="today">Aujourd'hui</option>
            <option value="yesterday">Hier</option>
            <option value="week">Cette semaine</option>
            <option value="month">Ce mois</option>
            <option value="last30">30 derniers jours</option>
          </select>
        </div>
      </div>
      
      <!-- Ligne 2: Type d'action, Utilisateur, Recherche -->
      <div class="filters-row">
        <div class="filter-group">
          <label class="filter-label">Type d'action</label>
          <select name="type_action" class="filter-select">
            <option value="">-- Toutes les actions --</option>
            {% for code, label in types_action %}
            <option value="{{ code }}" {% if type_action == code %}selected{% endif %}>
              {{ label }}
            </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Utilisateur</label>
          <select name="utilisateur" class="filter-select">
            <option value="">-- Tous --</option>
            {% for user in utilisateurs %}
            <option value="{{ user.id }}" {% if utilisateur_id|stringformat:"s" == user.id|stringformat:"s" %}selected{% endif %}>
              {{ user.nom_complet }}
            </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Niveau hiérarchique</label>
          <select name="niveau" class="filter-select">
            <option value="">-- Tous --</option>
            {% for code, label in niveaux %}
            <option value="{{ code }}" {% if niveau_hierarchique == code %}selected{% endif %}>
              {{ label }}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>
      
      <!-- Ligne 3: Recherche et par page -->
      <div class="filters-row">
        <div class="filter-group" style="flex: 2;">
          <label class="filter-label">Recherche</label>
          <input type="text" name="recherche" class="filter-input" 
                 value="{{ recherche }}" 
                 placeholder="Rechercher dans description, n° demande, matricule, IP...">
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Par page</label>
          <select name="per_page" class="filter-select">
            <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
          </select>
        </div>
      </div>
      
      <div class="filters-actions">
        <a href="{% url 'journal_logs' %}" class="btn btn-secondary">
          <i class="fas fa-times"></i> Réinitialiser
        </a>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-search"></i> Filtrer
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Tableau des logs -->
<div class="logs-table-card">
  <div class="logs-table-header">
    <h3><i class="fas fa-list"></i> Historique des actions ({{ logs.paginator.count }} résultats)</h3>
    
    <div class="export-buttons">
      <a href="{% url 'journal_logs_export' 'csv' %}?{{ request.GET.urlencode }}" class="btn btn-sm btn-outline">
        <i class="fas fa-file-csv"></i> CSV
      </a>
      <a href="{% url 'journal_logs_export' 'json' %}?{{ request.GET.urlencode }}" class="btn btn-sm btn-outline">
        <i class="fas fa-file-code"></i> JSON
      </a>
    </div>
  </div>
  
  {% if logs %}
  <div class="logs-table-container">
    <table class="logs-table">
      <thead>
        <tr>
          <th>Date/Heure</th>
          <th>Action</th>
          <th>Utilisateur</th>
          <th>Description</th>
          <th>Demande</th>
          <th>Niveau</th>
          <th>IP</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr>
          <td class="log-date">
            <div class="date">{{ log.created_at|date:"d/m/Y" }}</div>
            <div class="time">{{ log.created_at|time:"H:i:s" }}</div>
          </td>
          
          <td>
            <span class="log-action 
              {% if 'CREATION' in log.action %}creation
              {% elif 'MODIFICATION' in log.action %}modification
              {% elif 'VALIDATION' in log.action %}validation
              {% elif 'PROPOSITION' in log.action %}proposition
              {% elif 'ANNULATION' in log.action %}annulation
              {% elif 'NOTIFICATION' in log.action %}notification
              {% else %}autre{% endif %}">
              {% if 'CREATION' in log.action %}<i class="fas fa-plus"></i>
              {% elif 'MODIFICATION' in log.action %}<i class="fas fa-edit"></i>
              {% elif 'VALIDATION' in log.action %}<i class="fas fa-check"></i>
              {% elif 'PROPOSITION' in log.action %}<i class="fas fa-user-plus"></i>
              {% elif 'ANNULATION' in log.action %}<i class="fas fa-ban"></i>
              {% elif 'NOTIFICATION' in log.action %}<i class="fas fa-bell"></i>
              {% else %}<i class="fas fa-circle"></i>{% endif %}
              {{ log.get_action_display }}
            </span>
          </td>
          
          <td>
            <div class="log-user">
              <div class="log-user-avatar {% if not log.utilisateur %}system{% elif log.is_superuser %}superuser{% endif %}">
                {% if log.utilisateur %}
                  {% if log.is_superuser %}
                  <i class="fas fa-crown"></i>
                  {% else %}
                  {{ log.utilisateur.user.first_name|slice:":1"|upper }}{{ log.utilisateur.user.last_name|slice:":1"|upper }}
                  {% endif %}
                {% else %}
                <i class="fas fa-robot"></i>
                {% endif %}
              </div>
              <div class="log-user-info">
                <div class="log-user-name">
                  {{ log.utilisateur.nom_complet|default:"Système" }}
                </div>
                {% if log.utilisateur %}
                <div class="log-user-matricule">{{ log.utilisateur.matricule }}</div>
                {% endif %}
              </div>
            </div>
          </td>
          
          <td>
            <div class="log-description truncated" title="{{ log.description }}">
              {{ log.description|truncatewords:15 }}
            </div>
          </td>
          
          <td>
            {% if log.demande %}
            <span class="log-demande">{{ log.demande.numero_demande }}</span>
            {% else %}
            <span style="color: var(--gray-400);">-</span>
            {% endif %}
          </td>
          
          <td>
            {% if log.niveau_hierarchique %}
            <span class="log-niveau">{{ log.niveau_hierarchique }}</span>
            {% else %}
            <span style="color: var(--gray-400);">-</span>
            {% endif %}
          </td>
          
          <td>
            <span class="log-ip">{{ log.adresse_ip|default:"-" }}</span>
          </td>
          
          <td>
            <div class="log-actions">
              <button class="action-btn" onclick="showLogDetail({{ log.id }})" title="Voir détails">
                <i class="fas fa-eye"></i>
              </button>
              {% if log.demande %}
              <a href="{% url 'demande_detail' log.demande.id %}" class="action-btn" title="Voir demande">
                <i class="fas fa-external-link-alt"></i>
              </a>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <!-- Pagination -->
  <div class="pagination-container">
    <div class="pagination-info">
      Affichage de {{ logs.start_index }} à {{ logs.end_index }} sur {{ logs.paginator.count }} résultats
    </div>
    
    <div class="pagination">
      {% if logs.has_previous %}
      <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
        <i class="fas fa-angle-double-left"></i>
      </a>
      <a href="?page={{ logs.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
        <i class="fas fa-angle-left"></i>
      </a>
      {% endif %}
      
      {% for num in logs.paginator.page_range %}
        {% if num > logs.number|add:'-4' and num < logs.number|add:'4' %}
          {% if num == logs.number %}
          <span class="current">{{ num }}</span>
          {% else %}
          <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
          {% endif %}
        {% endif %}
      {% endfor %}
      
      {% if logs.has_next %}
      <a href="?page={{ logs.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
        <i class="fas fa-angle-right"></i>
      </a>
      <a href="?page={{ logs.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
        <i class="fas fa-angle-double-right"></i>
      </a>
      {% endif %}
    </div>
  </div>
  
  {% else %}
  <div class="empty-state">
    <i class="fas fa-inbox"></i>
    <h3>Aucun log trouvé</h3>
    <p>Modifiez vos critères de recherche ou réinitialisez les filtres</p>
  </div>
  {% endif %}
</div>

<!-- Modal détail du log -->
<div class="modal-overlay" id="logDetailModal">
  <div class="modal">
    <div class="modal-header">
      <h3><i class="fas fa-info-circle"></i> Détails du log</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="logDetailContent">
      <!-- Contenu chargé dynamiquement -->
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Toggle filtres
function toggleFilters() {
  const body = document.getElementById('filtersBody');
  const icon = document.getElementById('filtersIcon');
  
  body.classList.toggle('collapsed');
  icon.classList.toggle('fa-chevron-down');
  icon.classList.toggle('fa-chevron-up');
}

// Raccourcis de date
function setDateRange(range) {
  const today = new Date();
  let startDate, endDate;
  
  switch(range) {
    case 'today':
      startDate = today;
      endDate = today;
      break;
    case 'yesterday':
      startDate = new Date(today);
      startDate.setDate(startDate.getDate() - 1);
      endDate = startDate;
      break;
    case 'week':
      startDate = new Date(today);
      startDate.setDate(startDate.getDate() - startDate.getDay());
      endDate = today;
      break;
    case 'month':
      startDate = new Date(today.getFullYear(), today.getMonth(), 1);
      endDate = today;
      break;
    case 'last30':
      startDate = new Date(today);
      startDate.setDate(startDate.getDate() - 30);
      endDate = today;
      break;
    default:
      return;
  }
  
  document.querySelector('input[name="date_debut"]').value = formatDate(startDate);
  document.querySelector('input[name="date_fin"]').value = formatDate(endDate);
  document.querySelector('input[name="heure_debut"]').value = '00:00';
  document.querySelector('input[name="heure_fin"]').value = '23:59';
}

function formatDate(date) {
  return date.toISOString().split('T')[0];
}

// Modal détail
function showLogDetail(logId) {
  const modal = document.getElementById('logDetailModal');
  const content = document.getElementById('logDetailContent');
  
  content.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
  modal.classList.add('active');
  
  fetch(`{% url 'journal_logs_detail' 0 %}`.replace('0', logId))
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const log = data.log;
        content.innerHTML = `
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Date/Heure</div>
              <div class="detail-value">${log.date}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Action</div>
              <div class="detail-value">${log.action}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Utilisateur</div>
              <div class="detail-value">${log.utilisateur}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Matricule</div>
              <div class="detail-value">${log.matricule}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Email</div>
              <div class="detail-value">${log.email}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Demande</div>
              <div class="detail-value">${log.demande}${log.demande_id ? ` <a href="/interim/demande/${log.demande_id}/" target="_blank"><i class="fas fa-external-link-alt"></i></a>` : ''}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Niveau hiérarchique</div>
              <div class="detail-value">${log.niveau_hierarchique}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Niveau validation</div>
              <div class="detail-value">${log.niveau_validation || '-'}</div>
            </div>
            <div class="detail-item full">
              <div class="detail-label">Description</div>
              <div class="detail-value">${log.description}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Adresse IP</div>
              <div class="detail-value code">${log.adresse_ip}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Superuser</div>
              <div class="detail-value">${log.is_superuser ? '<span class="badge badge-superuser"><i class="fas fa-crown"></i> Oui</span>' : 'Non'}</div>
            </div>
            <div class="detail-item full">
              <div class="detail-label">User Agent</div>
              <div class="detail-value code" style="font-size: 0.75rem;">${log.user_agent}</div>
            </div>
            ${log.donnees_avant ? `
            <div class="detail-item full">
              <div class="detail-label">Données AVANT</div>
              <div class="json-preview">${JSON.stringify(log.donnees_avant, null, 2)}</div>
            </div>
            ` : ''}
            ${log.donnees_apres ? `
            <div class="detail-item full">
              <div class="detail-label">Données APRÈS</div>
              <div class="json-preview">${JSON.stringify(log.donnees_apres, null, 2)}</div>
            </div>
            ` : ''}
          </div>
        `;
      } else {
        content.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>${data.message}</p></div>`;
      }
    })
    .catch(error => {
      content.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Erreur de chargement</p></div>`;
    });
}

function closeModal() {
  document.getElementById('logDetailModal').classList.remove('active');
}

// Fermer avec Escape ou clic sur overlay
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeModal();
});

document.getElementById('logDetailModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
  console.log('Journal des logs initialisé');
});
</script>
{% endblock %}