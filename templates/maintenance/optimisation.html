{% extends 'base.html' %}
{% load static %}

{% block title %}Optimisation Syst√®me{% endblock %}

{% block extra_css %}
<style>
  .optimize-header {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 2rem;
  }

  .optimize-title {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .optimize-subtitle {
    opacity: 0.9;
  }

  .card {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    overflow: hidden;
    margin-bottom: 1.5rem;
  }

  .card-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .card-header.primary {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
  }

  .card-header.warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
  }

  .card-header.success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
  }

  .card-title {
    font-weight: 700;
    font-size: 1.1rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .card-body {
    padding: 1.5rem;
  }

  .suggestions-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .suggestion-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    border-radius: 0.75rem;
    border-left: 4px solid;
  }

  .suggestion-item.error {
    background: #fef2f2;
    border-color: #ef4444;
  }

  .suggestion-item.warning {
    background: #fffbeb;
    border-color: #f59e0b;
  }

  .suggestion-item.info {
    background: #eff6ff;
    border-color: #3b82f6;
  }

  .suggestion-icon {
    width: 40px;
    height: 40px;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .suggestion-item.error .suggestion-icon {
    background: #fee2e2;
    color: #ef4444;
  }

  .suggestion-item.warning .suggestion-icon {
    background: #fef3c7;
    color: #f59e0b;
  }

  .suggestion-item.info .suggestion-icon {
    background: #dbeafe;
    color: #3b82f6;
  }

  .suggestion-content {
    flex: 1;
  }

  .suggestion-title {
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.25rem;
  }

  .suggestion-desc {
    font-size: 0.875rem;
    color: #64748b;
    margin-bottom: 0.5rem;
  }

  .table {
    width: 100%;
    border-collapse: collapse;
  }

  .table th {
    text-align: left;
    padding: 0.75rem 1rem;
    background: #f8fafc;
    font-weight: 600;
    color: #64748b;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 2px solid #e2e8f0;
  }

  .table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f1f5f9;
  }

  .table tr:hover {
    background: #f8fafc;
  }

  .status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .status-badge.ok {
    background: #d1fae5;
    color: #059669;
  }

  .status-badge.warning {
    background: #fef3c7;
    color: #d97706;
  }

  .btn {
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    text-decoration: none;
  }

  .btn-primary {
    background: #3b82f6;
    color: white;
  }

  .btn-primary:hover {
    background: #2563eb;
  }

  .btn-success {
    background: #10b981;
    color: white;
  }

  .btn-success:hover {
    background: #059669;
  }

  .btn-warning {
    background: #f59e0b;
    color: white;
  }

  .btn-warning:hover {
    background: #d97706;
  }

  .btn-outline {
    background: white;
    color: #64748b;
    border: 2px solid #e2e8f0;
  }

  .btn-outline:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
  }

  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.8rem;
  }

  .action-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .action-card {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 1rem;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
  }

  .action-card:hover {
    border-color: #3b82f6;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
  }

  .action-card.running {
    border-color: #f59e0b;
    background: #fffbeb;
  }

  .action-card-icon {
    width: 50px;
    height: 50px;
    border-radius: 1rem;
    background: #f1f5f9;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 1.25rem;
    color: #64748b;
    transition: all 0.3s;
  }

  .action-card:hover .action-card-icon {
    background: #dbeafe;
    color: #3b82f6;
  }

  .action-card.running .action-card-icon {
    background: #fef3c7;
    color: #f59e0b;
  }

  .action-card-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: #1e293b;
  }

  .action-card-desc {
    font-size: 0.8rem;
    color: #94a3b8;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  }

  .stat-card-title {
    font-size: 0.875rem;
    color: #64748b;
    margin-bottom: 0.5rem;
  }

  .stat-card-value {
    font-size: 2rem;
    font-weight: 700;
    color: #1e293b;
  }

  .stat-card-value.success {
    color: #10b981;
  }

  .stat-card-value.warning {
    color: #f59e0b;
  }

  .stat-card-value.danger {
    color: #ef4444;
  }

  .progress-bar-container {
    background: #e2e8f0;
    border-radius: 9999px;
    height: 8px;
    overflow: hidden;
    margin-top: 0.75rem;
  }

  .progress-bar-fill {
    height: 100%;
    border-radius: 9999px;
    transition: width 0.5s ease;
  }

  .progress-bar-fill.success {
    background: linear-gradient(90deg, #10b981, #34d399);
  }

  .progress-bar-fill.warning {
    background: linear-gradient(90deg, #f59e0b, #fbbf24);
  }

  .progress-bar-fill.danger {
    background: linear-gradient(90deg, #ef4444, #f87171);
  }

  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #94a3b8;
  }

  .empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .spinning {
    animation: spin 1s linear infinite;
  }

  @media (max-width: 1200px) {
    .action-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .action-grid {
      grid-template-columns: 1fr;
    }
    .stats-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <!-- Fil d'Ariane -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'index' %}"><i class="fas fa-home me-1"></i> Accueil</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'admin_maintenance' %}">Maintenance</a>
      </li>
      <li class="breadcrumb-item active">Optimisation</li>
    </ol>
  </nav>

  <!-- En-t√™te -->
  <div class="optimize-header">
    <h1 class="optimize-title">
      <i class="fas fa-tachometer-alt"></i>
      Optimisation Syst√®me
    </h1>
    <p class="optimize-subtitle">
      Analysez et optimisez les performances de votre application
    </p>
  </div>

  <!-- Statistiques -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-card-title">Taille Base de Donn√©es</div>
      <div class="stat-card-value">{{ db_info.size }}</div>
      <div class="text-muted" style="font-size: 0.875rem;">{{ db_info.tables_count }} tables</div>
    </div>
    
    {% if system_stats.disk_usage %}
    <div class="stat-card">
      <div class="stat-card-title">Espace Disque</div>
      <div class="stat-card-value {% if system_stats.disk_usage.percent > 85 %}danger{% elif system_stats.disk_usage.percent > 70 %}warning{% else %}success{% endif %}">
        {{ system_stats.disk_usage.percent }}%
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar-fill {% if system_stats.disk_usage.percent > 85 %}danger{% elif system_stats.disk_usage.percent > 70 %}warning{% else %}success{% endif %}" 
             style="width: {{ system_stats.disk_usage.percent }}%"></div>
      </div>
    </div>
    {% endif %}
    
    {% if system_stats.memory_usage %}
    <div class="stat-card">
      <div class="stat-card-title">M√©moire</div>
      <div class="stat-card-value {% if system_stats.memory_usage.percent > 85 %}danger{% elif system_stats.memory_usage.percent > 70 %}warning{% else %}success{% endif %}">
        {{ system_stats.memory_usage.percent }}%
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar-fill {% if system_stats.memory_usage.percent > 85 %}danger{% elif system_stats.memory_usage.percent > 70 %}warning{% else %}success{% endif %}" 
             style="width: {{ system_stats.memory_usage.percent }}%"></div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Actions d'optimisation -->
  <div class="action-grid">
    <div class="action-card" id="vacuumCard" onclick="runVacuum()">
      <div class="action-card-icon">
        <i class="fas fa-compress-arrows-alt"></i>
      </div>
      <div class="action-card-title">VACUUM</div>
      <div class="action-card-desc">Optimiser la base de donn√©es</div>
    </div>
    
    <div class="action-card" id="cacheCard" onclick="clearCache()">
      <div class="action-card-icon">
        <i class="fas fa-broom"></i>
      </div>
      <div class="action-card-title">Vider Cache</div>
      <div class="action-card-desc">Nettoyer le cache syst√®me</div>
    </div>
    
    <div class="action-card" id="sessionsCard" onclick="clearSessions()">
      <div class="action-card-icon">
        <i class="fas fa-user-clock"></i>
      </div>
      <div class="action-card-title">Sessions</div>
      <div class="action-card-desc">Nettoyer les sessions expir√©es</div>
    </div>
    
    <div class="action-card" id="logsCard" onclick="archiveLogs()">
      <div class="action-card-icon">
        <i class="fas fa-archive"></i>
      </div>
      <div class="action-card-title">Archiver Logs</div>
      <div class="action-card-desc">Archiver les anciens journaux</div>
    </div>
  </div>

  <!-- Suggestions d'optimisation -->
  {% if suggestions %}
  <div class="card">
    <div class="card-header warning">
      <h5 class="card-title">
        <i class="fas fa-lightbulb"></i>
        Suggestions d'optimisation
      </h5>
    </div>
    <div class="card-body">
      <div class="suggestions-list">
        {% for suggestion in suggestions %}
        <div class="suggestion-item {{ suggestion.type }}">
          <div class="suggestion-icon">
            <i class="fas fa-{% if suggestion.type == 'error' %}exclamation-circle{% elif suggestion.type == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
          </div>
          <div class="suggestion-content">
            <div class="suggestion-title">{{ suggestion.title }}</div>
            <div class="suggestion-desc">{{ suggestion.description }}</div>
            {% if suggestion.action == 'create_backup' %}
            <a href="{% url 'backup_liste' %}" class="btn btn-sm btn-success">
              <i class="fas fa-cloud-upload-alt"></i> Cr√©er une sauvegarde
            </a>
            {% elif suggestion.action == 'check_cache' %}
            <button class="btn btn-sm btn-warning" onclick="clearCache()">
              <i class="fas fa-broom"></i> V√©rifier le cache
            </button>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% else %}
  <div class="card">
    <div class="card-header success">
      <h5 class="card-title">
        <i class="fas fa-check-circle"></i>
        Syst√®me optimis√©
      </h5>
    </div>
    <div class="card-body">
      <div class="empty-state">
        <i class="fas fa-thumbs-up"></i>
        <h5>Tout est en ordre !</h5>
        <p>Aucune suggestion d'optimisation pour le moment.</p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Analyse des tables -->
  {% if tables_analysis %}
  <div class="card">
    <div class="card-header primary">
      <h5 class="card-title">
        <i class="fas fa-table"></i>
        Analyse des tables
      </h5>
      <span style="opacity: 0.8; font-size: 0.875rem;">Top 20 par volume</span>
    </div>
    <div class="card-body p-0">
      <table class="table">
        <thead>
          <tr>
            <th>Table</th>
            <th>Enregistrements</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody>
          {% for table in tables_analysis %}
          <tr>
            <td>
              <strong>{{ table.name }}</strong>
            </td>
            <td>{{ table.rows|default:"0" }}</td>
            <td>
              <span class="status-badge {% if table.status == 'ok' %}ok{% else %}warning{% endif %}">
                {% if table.status == 'ok' %}OK{% else %}√Ä surveiller{% endif %}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Retour -->
  <div class="mt-4">
    <a href="{% url 'admin_maintenance' %}" class="btn btn-outline">
      <i class="fas fa-arrow-left"></i> Retour √† la maintenance
    </a>
  </div>
</div>

<!-- Modal archivage logs -->
<div class="modal fade" id="archiveLogsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-archive me-2"></i>
          Archiver les logs
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Archiver et supprimer les logs plus anciens que :</p>
        <div class="mb-3">
          <select class="form-select" id="archiveDays">
            <option value="30">30 jours</option>
            <option value="60">60 jours</option>
            <option value="90" selected>90 jours</option>
            <option value="180">180 jours</option>
            <option value="365">1 an</option>
          </select>
        </div>
        <p class="text-muted small">
          <i class="fas fa-info-circle me-1"></i>
          Les logs seront archiv√©s dans un fichier JSON avant suppression.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-warning" id="confirmArchiveBtn">
          <i class="fas fa-archive"></i> Archiver
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const csrfToken = '{{ csrf_token }}';

function showNotification(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
      <span>${message}</span>
      <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
    </div>
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 5000);
}

function setCardRunning(cardId, running) {
  const card = document.getElementById(cardId);
  if (!card) return;
  
  const icon = card.querySelector('.action-card-icon i');
  if (running) {
    card.classList.add('running');
    icon.className = 'fas fa-spinner spinning';
  } else {
    card.classList.remove('running');
    // Restaurer l'ic√¥ne originale
    const icons = {
      'vacuumCard': 'fa-compress-arrows-alt',
      'cacheCard': 'fa-broom',
      'sessionsCard': 'fa-user-clock',
      'logsCard': 'fa-archive'
    };
    icon.className = 'fas ' + (icons[cardId] || 'fa-cog');
  }
}

function runVacuum() {
  setCardRunning('vacuumCard', true);
  showNotification('Optimisation VACUUM en cours...', 'info');
  
  fetch('{% url "optimisation_vacuum" %}', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    setCardRunning('vacuumCard', false);
    if (data.success) {
      showNotification(data.message, 'success');
    } else {
      showNotification(data.error || 'Erreur', 'error');
    }
  })
  .catch(error => {
    setCardRunning('vacuumCard', false);
    console.error('Erreur:', error);
    showNotification('Erreur lors de l\'optimisation', 'error');
  });
}

function clearCache() {
  setCardRunning('cacheCard', true);
  showNotification('Vidage du cache en cours...', 'info');
  
  fetch('{% url "optimisation_clear_cache" %}', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    setCardRunning('cacheCard', false);
    if (data.success) {
      showNotification(data.message, 'success');
    } else {
      showNotification(data.error || 'Erreur', 'error');
    }
  })
  .catch(error => {
    setCardRunning('cacheCard', false);
    console.error('Erreur:', error);
    showNotification('Erreur lors du vidage du cache', 'error');
  });
}

function clearSessions() {
  setCardRunning('sessionsCard', true);
  showNotification('Nettoyage des sessions...', 'info');
  
  fetch('{% url "optimisation_clear_sessions" %}', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    setCardRunning('sessionsCard', false);
    if (data.success) {
      showNotification(data.message, 'success');
    } else {
      showNotification(data.error || 'Erreur', 'error');
    }
  })
  .catch(error => {
    setCardRunning('sessionsCard', false);
    console.error('Erreur:', error);
    showNotification('Erreur lors du nettoyage', 'error');
  });
}

function archiveLogs() {
  const modal = new bootstrap.Modal(document.getElementById('archiveLogsModal'));
  modal.show();
}

document.getElementById('confirmArchiveBtn').addEventListener('click', function() {
  const days = document.getElementById('archiveDays').value;
  const btn = this;
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner spinning"></i> Archivage...';
  btn.disabled = true;
  
  fetch('{% url "optimisation_archive_logs" %}', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: `days=${days}`
  })
  .then(response => response.json())
  .then(data => {
    bootstrap.Modal.getInstance(document.getElementById('archiveLogsModal')).hide();
    if (data.success) {
      showNotification(data.message, 'success');
    } else {
      showNotification(data.error || 'Erreur', 'error');
    }
    btn.innerHTML = originalText;
    btn.disabled = false;
  })
  .catch(error => {
    console.error('Erreur:', error);
    showNotification('Erreur lors de l\'archivage', 'error');
    btn.innerHTML = originalText;
    btn.disabled = false;
  });
});

console.log('üöÄ Module Optimisation charg√©');
</script>
{% endblock %}
