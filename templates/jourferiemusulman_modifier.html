{% extends 'base.html' %}
{% load static %}

{% block title %}Modifier {{ ferie.nom }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <!-- Fil d'Ariane -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'jourferie_liste' %}">
          <i class="fas fa-calendar-alt me-1"></i> Jours Fériés
        </a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'jourferie_afficher' ferie.pk %}">{{ ferie.nom }}</a>
      </li>
      <li class="breadcrumb-item active">Modifier</li>
    </ol>
  </nav>
  
  <div class="row justify-content-center">
    <div class="col-lg-8 col-xl-7">
      <div class="card shadow-sm">
        <!-- En-tête -->
        <div class="card-header bg-success text-white py-3">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
              <i class="fas fa-moon me-2"></i>
              Modifier la date du jour férié
            </h4>
            <span class="badge bg-light text-dark">{{ ferie.annee }}</span>
          </div>
        </div>
        
        <div class="card-body p-4">
          <!-- Informations sur le jour férié -->
          <div class="ferie-info-card mb-4 p-3 rounded">
            <div class="row align-items-center">
              <div class="col-auto">
                <div class="ferie-icon bg-success text-white rounded-circle">
                  <i class="fas fa-moon"></i>
                </div>
              </div>
              <div class="col">
                <h5 class="mb-1">{{ ferie.nom }}</h5>
                <div class="text-muted">
                  <i class="fas fa-calendar me-1"></i>
                  Date actuelle: <strong>{{ ferie.date_ferie|date:"l d F Y" }}</strong>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Alerte d'information -->
          <div class="alert alert-info mb-4">
            <div class="d-flex">
              <i class="fas fa-info-circle fa-lg me-3 mt-1"></i>
              <div>
                <strong>Pourquoi modifier cette date ?</strong>
                <p class="mb-0">
                  Les dates des fêtes musulmanes sont calculées selon le calendrier Hijri, mais peuvent 
                  varier selon l'observation de la lune par les autorités religieuses locales (COSIM en Côte d'Ivoire).
                  Utilisez cette fonction pour ajuster la date officielle.
                </p>
              </div>
            </div>
          </div>
          
          <!-- Comparaison des dates -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="date-box date-calculated p-3 rounded">
                <label class="small text-muted d-block mb-2">
                  <i class="fas fa-calculator me-1"></i> Date calculée (Hijri)
                </label>
                <span class="fs-4 fw-bold">
                  {% if ferie.date_calculee %}
                  {{ ferie.date_calculee|date:"d/m/Y" }}
                  {% else %}
                  Non disponible
                  {% endif %}
                </span>
                <br>
                <small class="text-muted">
                  {% if ferie.date_calculee %}
                  {{ ferie.date_calculee|date:"l" }}
                  {% endif %}
                </small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="date-box date-current p-3 rounded {% if ferie.est_modifie %}date-modified{% endif %}">
                <label class="small text-muted d-block mb-2">
                  <i class="fas fa-calendar-check me-1"></i> Date actuelle
                  {% if ferie.est_modifie %}
                  <span class="badge bg-warning text-dark ms-1">Modifiée</span>
                  {% endif %}
                </label>
                <span class="fs-4 fw-bold">{{ ferie.date_ferie|date:"d/m/Y" }}</span>
                <br>
                <small class="text-muted">{{ ferie.date_ferie|date:"l" }}</small>
              </div>
            </div>
          </div>
          
          <!-- Formulaire -->
          <form method="POST" id="formModifierFerie">
            {% csrf_token %}
            <input type="hidden" name="action" value="modifier" id="formAction">
            
            <!-- Nouvelle date -->
            <div class="mb-4">
              <label for="nouvelle_date" class="form-label fw-semibold">
                <i class="fas fa-calendar-alt me-1 text-primary"></i>
                Nouvelle date <span class="text-danger">*</span>
              </label>
              <input type="date" 
                     class="form-control form-control-lg" 
                     id="nouvelle_date" 
                     name="nouvelle_date" 
                     value="{{ ferie.date_ferie|date:'Y-m-d' }}"
                     required>
            </div>
            
            <!-- Aperçu de la nouvelle date -->
            <div class="mb-4" id="apercu-date" style="display: none;">
              <div class="alert alert-secondary">
                <div class="d-flex align-items-center">
                  <i class="fas fa-arrow-right fa-lg me-3 text-success"></i>
                  <div>
                    <strong>Nouvelle date: </strong>
                    <span id="apercu-date-complete"></span>
                    <span id="apercu-diff" class="badge ms-2"></span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Motif -->
            <div class="mb-4">
              <label for="motif" class="form-label fw-semibold">
                <i class="fas fa-comment me-1 text-primary"></i>
                Motif de la modification <span class="text-danger">*</span>
              </label>
              <textarea class="form-control" 
                        id="motif" 
                        name="motif" 
                        rows="3"
                        placeholder="Ex: Date confirmée par le COSIM..."
                        required></textarea>
              <div class="form-text">
                Expliquez pourquoi vous modifiez cette date.
              </div>
            </div>
            
            <!-- Source -->
            <div class="mb-4">
              <label for="source" class="form-label fw-semibold">
                <i class="fas fa-link me-1 text-primary"></i>
                Source de l'information (optionnel)
              </label>
              <input type="text" 
                     class="form-control" 
                     id="source" 
                     name="source" 
                     placeholder="Ex: Communiqué COSIM, RTI, Fraternité Matin...">
            </div>
            
            <hr class="my-4">
            
            <!-- Boutons -->
            <div class="d-flex justify-content-between flex-wrap gap-2">
              <a href="{% url 'jourferie_afficher' ferie.pk %}" class="btn btn-outline-secondary btn-lg">
                <i class="fas fa-times me-2"></i>
                Annuler
              </a>
              
              <div class="btn-group">
                {% if ferie.est_modifie and ferie.date_calculee %}
                <button type="button" class="btn btn-outline-warning btn-lg" id="btnReinitialiser">
                  <i class="fas fa-undo me-2"></i>
                  Réinitialiser
                </button>
                {% endif %}
                
                <button type="submit" class="btn btn-success btn-lg" id="btnSubmit">
                  <i class="fas fa-save me-2"></i>
                  Enregistrer
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
      
      <!-- Historique des modifications -->
      {% if historique %}
      <div class="card shadow-sm mt-4">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fas fa-history me-2"></i> Historique des modifications
          </h6>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Action</th>
                  <th>Détails</th>
                  <th>Par</th>
                </tr>
              </thead>
              <tbody>
                {% for h in historique %}
                <tr>
                  <td class="text-nowrap">{{ h.date_action|date:"d/m/Y H:i" }}</td>
                  <td>
                    <span class="badge 
                      {% if h.action == 'MODIFICATION' %}bg-warning text-dark
                      {% elif h.action == 'CREATION' %}bg-success
                      {% else %}bg-secondary{% endif %}">
                      {{ h.get_action_display }}
                    </span>
                  </td>
                  <td>
                    {% if h.ancienne_valeur and h.nouvelle_valeur %}
                    {{ h.ancienne_valeur }} → {{ h.nouvelle_valeur }}
                    {% endif %}
                    {% if h.motif %}
                    <br><small class="text-muted">{{ h.motif|truncatewords:8 }}</small>
                    {% endif %}
                  </td>
                  <td>{{ h.effectue_par|default:"Système" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal de confirmation de réinitialisation -->
<div class="modal fade" id="modalReinitialiser" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">
          <i class="fas fa-undo me-2"></i>
          Réinitialiser la date
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Voulez-vous réinitialiser la date de <strong>{{ ferie.nom }}</strong> à sa valeur calculée ?</p>
        <div class="d-flex justify-content-around my-4">
          <div class="text-center">
            <div class="text-muted small">Date actuelle</div>
            <div class="fs-4 text-decoration-line-through">{{ ferie.date_ferie|date:"d/m/Y" }}</div>
          </div>
          <div class="align-self-center">
            <i class="fas fa-arrow-right fa-2x text-warning"></i>
          </div>
          <div class="text-center">
            <div class="text-muted small">Date calculée</div>
            <div class="fs-4 fw-bold text-success">{{ ferie.date_calculee|date:"d/m/Y" }}</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-warning" id="btnConfirmerReinit">
          <i class="fas fa-undo me-2"></i>
          Réinitialiser
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.ferie-info-card {
  background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
  border-left: 4px solid #28a745;
}

.ferie-icon {
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.date-box {
  background: #f8f9fa;
  border: 2px solid #dee2e6;
}

.date-box.date-modified {
  background: #fff3cd;
  border-color: #ffc107;
}

.form-control-lg {
  font-size: 1rem;
}

@media (max-width: 768px) {
  .d-flex.justify-content-between {
    flex-direction: column;
  }
  
  .d-flex.justify-content-between > * {
    width: 100%;
    margin-bottom: 0.5rem;
  }
  
  .btn-group {
    display: flex;
    flex-direction: column;
    width: 100%;
  }
  
  .btn-group .btn {
    border-radius: 0.375rem !important;
    margin-bottom: 0.5rem;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const dateInput = document.getElementById('nouvelle_date');
  const apercuDiv = document.getElementById('apercu-date');
  const apercuDateComplete = document.getElementById('apercu-date-complete');
  const apercuDiff = document.getElementById('apercu-diff');
  const dateActuelle = new Date('{{ ferie.date_ferie|date:"Y-m-d" }}T00:00:00');
  
  const joursSemaine = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
  const mois = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 
                'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];
  
  // Mise à jour de l'aperçu
  dateInput.addEventListener('change', function() {
    if (this.value) {
      const nouvelleDate = new Date(this.value + 'T00:00:00');
      const jourSemaine = joursSemaine[nouvelleDate.getDay()];
      const jour = nouvelleDate.getDate();
      const moisNom = mois[nouvelleDate.getMonth()];
      const annee = nouvelleDate.getFullYear();
      
      apercuDateComplete.textContent = `${jourSemaine} ${jour} ${moisNom} ${annee}`;
      
      // Calculer la différence
      const diffJours = Math.round((nouvelleDate - dateActuelle) / (1000 * 60 * 60 * 24));
      
      if (diffJours === 0) {
        apercuDiff.textContent = 'Aucun changement';
        apercuDiff.className = 'badge bg-secondary ms-2';
      } else if (diffJours > 0) {
        apercuDiff.textContent = `+${diffJours} jour(s)`;
        apercuDiff.className = 'badge bg-success ms-2';
      } else {
        apercuDiff.textContent = `${diffJours} jour(s)`;
        apercuDiff.className = 'badge bg-warning text-dark ms-2';
      }
      
      apercuDiv.style.display = 'block';
    } else {
      apercuDiv.style.display = 'none';
    }
  });
  
  // Déclencher l'événement au chargement
  dateInput.dispatchEvent(new Event('change'));
  
  // Bouton réinitialiser
  const btnReinit = document.getElementById('btnReinitialiser');
  if (btnReinit) {
    const modalReinit = new bootstrap.Modal(document.getElementById('modalReinitialiser'));
    
    btnReinit.addEventListener('click', function() {
      modalReinit.show();
    });
    
    document.getElementById('btnConfirmerReinit').addEventListener('click', function() {
      document.getElementById('formAction').value = 'reinitialiser';
      document.getElementById('formModifierFerie').submit();
    });
  }
  
  // Validation du formulaire
  document.getElementById('formModifierFerie').addEventListener('submit', function(e) {
    const action = document.getElementById('formAction').value;
    
    if (action === 'modifier') {
      const nouvelleDate = document.getElementById('nouvelle_date').value;
      const motif = document.getElementById('motif').value.trim();
      
      if (!nouvelleDate) {
        e.preventDefault();
        alert('Veuillez sélectionner une nouvelle date.');
        return;
      }
      
      if (!motif) {
        e.preventDefault();
        alert('Veuillez saisir un motif pour la modification.');
        document.getElementById('motif').focus();
        return;
      }
    }
    
    // Désactiver le bouton
    const btn = document.getElementById('btnSubmit');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enregistrement...';
  });
});
</script>
{% endblock %}