{% extends "base.html" %}
{% load static %}

{% block title %}Gestion des Utilisateurs{% endblock %}

{% block extra_css %}
<style>
  /* En-t√™te de page */
  .page-header {
    background: linear-gradient(135deg, var(--gray-800) 0%, var(--gray-700) 50%, var(--gray-600) 100%);
    color: white;
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
  }

  .page-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at 20% 20%, rgba(255,255,255,0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(255,255,255,0.1) 0%, transparent 50%);
  }

  .page-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
    z-index: 1;
  }

  .page-subtitle {
    font-size: 1rem;
    opacity: 0.9;
    position: relative;
    z-index: 1;
  }

  /* Stats cards */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
    position: relative;
    z-index: 1;
  }

  .stat-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    padding: 1rem;
    text-align: center;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .stat-value {
    font-size: 1.75rem;
    font-weight: 700;
  }

  .stat-label {
    font-size: 0.85rem;
    opacity: 0.9;
  }

  /* Toolbar */
  .toolbar {
    background: white;
    border-radius: 1rem;
    box-shadow: var(--shadow);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .toolbar-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
  }

  .toolbar-row + .toolbar-row {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--gray-200);
  }

  .search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
  }

  .search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border: 2px solid var(--gray-200);
    border-radius: 0.5rem;
    font-size: 1rem;
    transition: all 0.3s;
  }

  .search-box input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .search-box i {
    position: absolute;
    left: 0.875rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-400);
  }

  .filter-select {
    padding: 0.75rem 1rem;
    border: 2px solid var(--gray-200);
    border-radius: 0.5rem;
    font-size: 0.9rem;
    min-width: 150px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .filter-select:focus {
    border-color: var(--primary);
    outline: none;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border: none;
    border-radius: 0.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
  }

  .btn-primary {
    background: var(--primary);
    color: white;
  }

  .btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
  }

  .btn-success {
    background: var(--secondary);
    color: white;
  }

  .btn-success:hover {
    background: var(--secondary-dark);
  }

  .btn-outline {
    background: transparent;
    border: 2px solid var(--gray-300);
    color: var(--gray-700);
  }

  .btn-outline:hover {
    border-color: var(--primary);
    color: var(--primary);
  }

  .btn-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
  }

  .btn-icon {
    width: 36px;
    height: 36px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
  }

  /* Table */
  .table-container {
    background: white;
    border-radius: 1rem;
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .table-header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .table-header h3 {
    margin: 0;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .table-responsive {
    overflow-x: auto;
  }

  .users-table {
    width: 100%;
    border-collapse: collapse;
  }

  .users-table th {
    background: var(--gray-50);
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--gray-700);
    border-bottom: 2px solid var(--gray-200);
    white-space: nowrap;
  }

  .users-table th a {
    color: var(--gray-700);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .users-table th a:hover {
    color: var(--primary);
  }

  .users-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--gray-100);
    vertical-align: middle;
  }

  .users-table tbody tr {
    transition: background 0.2s;
  }

  .users-table tbody tr:hover {
    background: var(--gray-50);
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary-light);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    font-weight: 600;
    font-size: 0.9rem;
    flex-shrink: 0;
  }

  .user-avatar.superuser {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: white;
  }

  .user-avatar.kelio {
    background: var(--secondary-light);
    color: var(--secondary);
  }

  .user-details {
    display: flex;
    flex-direction: column;
  }

  .user-name {
    font-weight: 600;
    color: var(--gray-800);
  }

  .user-email {
    font-size: 0.8rem;
    color: var(--gray-500);
  }

  /* Badges */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .badge-primary {
    background: var(--primary-light);
    color: var(--primary);
  }

  .badge-success {
    background: var(--secondary-light);
    color: var(--secondary-dark);
  }

  .badge-warning {
    background: #fef3c7;
    color: #92400e;
  }

  .badge-danger {
    background: #fee2e2;
    color: #991b1b;
  }

  .badge-info {
    background: #dbeafe;
    color: #1e40af;
  }

  .badge-gray {
    background: var(--gray-100);
    color: var(--gray-600);
  }

  .badge-superuser {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: white;
  }

  .badge-kelio {
    background: #ecfdf5;
    color: #065f46;
  }

  .badge-local {
    background: #f3f4f6;
    color: #4b5563;
  }

  /* Status indicator */
  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
  }

  .status-dot.active {
    background: var(--secondary);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
  }

  .status-dot.inactive {
    background: var(--gray-400);
  }

  /* Actions */
  .actions-cell {
    display: flex;
    gap: 0.5rem;
  }

  .action-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 0.375rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--gray-100);
    color: var(--gray-600);
  }

  .action-btn:hover {
    background: var(--primary-light);
    color: var(--primary);
  }

  .action-btn.danger:hover {
    background: #fee2e2;
    color: #dc2626;
  }

  .action-btn.success:hover {
    background: var(--secondary-light);
    color: var(--secondary);
  }

  /* Pagination */
  .pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--gray-200);
    flex-wrap: wrap;
    gap: 1rem;
  }

  .pagination-info {
    color: var(--gray-600);
    font-size: 0.9rem;
  }

  .pagination {
    display: flex;
    gap: 0.25rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .pagination a, .pagination span {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    height: 36px;
    padding: 0 0.75rem;
    border: 1px solid var(--gray-200);
    border-radius: 0.375rem;
    text-decoration: none;
    color: var(--gray-700);
    font-size: 0.9rem;
    transition: all 0.2s;
  }

  .pagination a:hover {
    background: var(--primary-light);
    border-color: var(--primary);
    color: var(--primary);
  }

  .pagination .active span {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
  }

  .pagination .disabled span {
    background: var(--gray-100);
    color: var(--gray-400);
    cursor: not-allowed;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 1rem;
  }

  .modal-overlay.active {
    display: flex;
  }

  .modal {
    background: white;
    border-radius: 1rem;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  .modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray-500);
    padding: 0.25rem;
  }

  .modal-close:hover {
    color: var(--gray-800);
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--gray-200);
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
  }

  .detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .detail-item {
    padding: 0.75rem;
    background: var(--gray-50);
    border-radius: 0.5rem;
  }

  .detail-label {
    font-size: 0.75rem;
    color: var(--gray-500);
    margin-bottom: 0.25rem;
  }

  .detail-value {
    font-weight: 600;
    color: var(--gray-800);
  }

  .detail-item.full-width {
    grid-column: 1 / -1;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--gray-500);
  }

  .empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .empty-state h3 {
    margin-bottom: 0.5rem;
    color: var(--gray-700);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .toolbar-row {
      flex-direction: column;
    }

    .search-box {
      width: 100%;
    }

    .filter-select {
      width: 100%;
    }

    .stats-row {
      grid-template-columns: repeat(2, 1fr);
    }

    .detail-grid {
      grid-template-columns: 1fr;
    }

    .actions-cell {
      flex-direction: column;
    }
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .users-table tbody tr {
    animation: fadeIn 0.3s ease-out;
  }
</style>
{% endblock %}

{% block content %}
<!-- En-t√™te de page -->
<div class="page-header">
  <div class="page-title">
    <i class="fas fa-users-cog"></i>
    Gestion des Utilisateurs
  </div>
  <div class="page-subtitle">
    Administration des comptes utilisateurs et profils
  </div>
  
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-value">{{ stats.total }}</div>
      <div class="stat-label">Total utilisateurs</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.actifs }}</div>
      <div class="stat-label">Actifs</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.kelio }}</div>
      <div class="stat-label">Kelio</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.locaux }}</div>
      <div class="stat-label">Locaux</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.superusers }}</div>
      <div class="stat-label">Super admins</div>
    </div>
  </div>
</div>

<!-- Toolbar -->
<div class="toolbar">
  <form method="GET" action="{% url 'admin_users_liste' %}" id="filterForm">
    <div class="toolbar-row">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" name="search" placeholder="Rechercher par nom, matricule, email..." 
               value="{{ search_query }}" autocomplete="off">
      </div>
      
      <a href="{% url 'ajouter_superutilisateur' %}" class="btn btn-success">
        <i class="fas fa-user-plus"></i>
        Ajouter un super utilisateur
      </a>
    </div>
    
    <div class="toolbar-row">
      <select name="type_profil" class="filter-select" onchange="this.form.submit()">
        <option value="">Tous les profils</option>
        {% for code, label in types_profil %}
        <option value="{{ code }}" {% if type_profil_filter == code %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      
      <select name="statut" class="filter-select" onchange="this.form.submit()">
        <option value="">Tous les statuts</option>
        {% for code, label in statuts_employe %}
        <option value="{{ code }}" {% if statut_filter == code %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      
      <select name="departement" class="filter-select" onchange="this.form.submit()">
        <option value="">Tous les d√©partements</option>
        {% for dept in departements %}
        <option value="{{ dept.id }}" {% if departement_filter == dept.id|stringformat:"s" %}selected{% endif %}>{{ dept.nom }}</option>
        {% endfor %}
      </select>
      
      <select name="source" class="filter-select" onchange="this.form.submit()">
        <option value="">Toutes sources</option>
        <option value="kelio" {% if source_filter == 'kelio' %}selected{% endif %}>Kelio uniquement</option>
        <option value="local" {% if source_filter == 'local' %}selected{% endif %}>Locaux uniquement</option>
      </select>
      
      <select name="actif" class="filter-select" onchange="this.form.submit()">
        <option value="">Actifs & Inactifs</option>
        <option value="actif" {% if actif_filter == 'actif' %}selected{% endif %}>Actifs uniquement</option>
        <option value="inactif" {% if actif_filter == 'inactif' %}selected{% endif %}>Inactifs uniquement</option>
      </select>
      
      <select name="per_page" class="filter-select" onchange="this.form.submit()">
        <option value="10" {% if per_page == 10 %}selected{% endif %}>10 par page</option>
        <option value="25" {% if per_page == 25 %}selected{% endif %}>25 par page</option>
        <option value="50" {% if per_page == 50 %}selected{% endif %}>50 par page</option>
        <option value="100" {% if per_page == 100 %}selected{% endif %}>100 par page</option>
      </select>
      
      {% if search_query or type_profil_filter or statut_filter or departement_filter or source_filter or actif_filter %}
      <a href="{% url 'admin_users_liste' %}" class="btn btn-outline">
        <i class="fas fa-times"></i>
        R√©initialiser
      </a>
      {% endif %}
    </div>
  </form>
</div>

<!-- Tableau des utilisateurs -->
<div class="table-container">
  <div class="table-header">
    <h3>
      <i class="fas fa-list"></i>
      Liste des utilisateurs
      <span class="badge badge-info">{{ stats.filtres_actifs }} r√©sultat{{ stats.filtres_actifs|pluralize }}</span>
    </h3>
  </div>
  
  {% if users %}
  <div class="table-responsive">
    <table class="users-table">
      <thead>
        <tr>
          <th>
            <a href="?{% if sort_by == 'user__last_name' %}&sort=-user__last_name{% else %}&sort=user__last_name{% endif %}&search={{ search_query }}&type_profil={{ type_profil_filter }}&statut={{ statut_filter }}&departement={{ departement_filter }}&source={{ source_filter }}&actif={{ actif_filter }}&per_page={{ per_page }}">
              Utilisateur
              {% if sort_by == 'user__last_name' %}<i class="fas fa-sort-up"></i>{% elif sort_by == '-user__last_name' %}<i class="fas fa-sort-down"></i>{% endif %}
            </a>
          </th>
          <th>
            <a href="?{% if sort_by == 'matricule' %}&sort=-matricule{% else %}&sort=matricule{% endif %}&search={{ search_query }}&type_profil={{ type_profil_filter }}&statut={{ statut_filter }}&departement={{ departement_filter }}&source={{ source_filter }}&actif={{ actif_filter }}&per_page={{ per_page }}">
              Matricule
              {% if sort_by == 'matricule' %}<i class="fas fa-sort-up"></i>{% elif sort_by == '-matricule' %}<i class="fas fa-sort-down"></i>{% endif %}
            </a>
          </th>
          <th>
            <a href="?{% if sort_by == 'type_profil' %}&sort=-type_profil{% else %}&sort=type_profil{% endif %}&search={{ search_query }}&type_profil={{ type_profil_filter }}&statut={{ statut_filter }}&departement={{ departement_filter }}&source={{ source_filter }}&actif={{ actif_filter }}&per_page={{ per_page }}">
              Profil
              {% if sort_by == 'type_profil' %}<i class="fas fa-sort-up"></i>{% elif sort_by == '-type_profil' %}<i class="fas fa-sort-down"></i>{% endif %}
            </a>
          </th>
          <th>
            <a href="?{% if sort_by == 'departement__nom' %}&sort=-departement__nom{% else %}&sort=departement__nom{% endif %}&search={{ search_query }}&type_profil={{ type_profil_filter }}&statut={{ statut_filter }}&departement={{ departement_filter }}&source={{ source_filter }}&actif={{ actif_filter }}&per_page={{ per_page }}">
              D√©partement
              {% if sort_by == 'departement__nom' %}<i class="fas fa-sort-up"></i>{% elif sort_by == '-departement__nom' %}<i class="fas fa-sort-down"></i>{% endif %}
            </a>
          </th>
          <th>Source</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr data-user-id="{{ user.pk }}">
          <td>
            <div class="user-info">
              <div class="user-avatar {% if user.user.is_superuser %}superuser{% elif user.kelio_employee_key %}kelio{% endif %}">
                {% if user.user.is_superuser %}
                <i class="fas fa-crown"></i>
                {% elif user.user %}
                {{ user.user.first_name|slice:":1"|upper }}{{ user.user.last_name|slice:":1"|upper }}
                {% else %}
                <i class="fas fa-user"></i>
                {% endif %}
              </div>
              <div class="user-details">
                <span class="user-name">{{ user.nom_complet }}</span>
                <span class="user-email">{{ user.user.email|default:"-" }}</span>
              </div>
            </div>
          </td>
          <td>
            <code>{{ user.matricule }}</code>
          </td>
          <td>
            {% if user.user.is_superuser %}
            <span class="badge badge-superuser">
              <i class="fas fa-crown"></i> Super Admin
            </span>
            {% else %}
            <span class="badge badge-primary">{{ user.get_type_profil_display }}</span>
            {% endif %}
          </td>
          <td>
            {% if user.departement %}
            {{ user.departement.nom }}
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td>
            {% if user.kelio_employee_key %}
            <span class="badge badge-kelio">
              <i class="fas fa-sync"></i> Kelio
            </span>
            {% else %}
            <span class="badge badge-local">
              <i class="fas fa-database"></i> Local
            </span>
            {% endif %}
          </td>
          <td>
            {% if user.actif %}
            <span><span class="status-dot active"></span>Actif</span>
            {% else %}
            <span><span class="status-dot inactive"></span>Inactif</span>
            {% endif %}
          </td>
          <td>
            <div class="actions-cell">                
              <a class="action-btn" href="{% url 'user_details' user.matricule %}" title="Voir d√©tails">
                <i class="fas fa-eye"></i>
              </a>
              <a href="{% url 'user_modifier' user.matricule %}"" class="action-btn" title="Modifier">
                <i class="fas fa-edit"></i>
              </a>
              <button class="action-btn {% if user.actif %}danger{% else %}success{% endif %}" 
                      onclick="toggleUserActif({{ user.pk }}, {{ user.actif|yesno:'true,false' }})"
                      title="{% if user.actif %}D√©sactiver{% else %}Activer{% endif %}">
                <i class="fas fa-{% if user.actif %}ban{% else %}check{% endif %}"></i>
              </button>
              <button class="action-btn" onclick="showResetPassword({{ user.pk }}, '{{ user.nom_complet|escapejs }}')" title="R√©initialiser mot de passe">
                <i class="fas fa-key"></i>
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <!-- Pagination -->
  <div class="pagination-container">
    <div class="pagination-info">
      Affichage de {{ users.start_index }} √† {{ users.end_index }} sur {{ users.paginator.count }} utilisateurs
    </div>
    
    <ul class="pagination">
      {% if users.has_previous %}
      <li>
        <a href="?page=1&search={{ search_query }}&type_profil={{ type_profil_filter }}&statut={{ statut_filter }}&departement={{ departement_filter }}&source={{ source_filter }}&actif={{ actif_filter }}&sort={{ sort_by }}&per_page={{ per_page }}">
          <i class="fas fa-angle-double-left"></i>
        </a>
      </li>
      <li>
        <a href="?page={{ users.previous_page_number }}&search={{ search_query }}&type_profil={{ type_profil_filter }}&statut={{ statut_filter }}&departement={{ departement_filter }}&source={{ source_filter }}&actif={{ actif_filter }}&sort={{ sort_by }}&per_page={{ per_page }}">
          <i class="fas fa-angle-left"></i>
        </a>
      </li>
      {% else %}
      <li class="disabled"><span><i class="fas fa-angle-double-left"></i></span></li>
      <li class="disabled"><span><i class="fas fa-angle-left"></i></span></li>
      {% endif %}
      
      {% for num in users.paginator.page_range %}
        {% if users.number == num %}
        <li class="active"><span>{{ num }}</span></li>
        {% elif num > users.number|add:'-3' and num < users.number|add:'3' %}
        <li>
          <a href="?page={{ num }}&search={{ search_query }}&type_profil={{ type_profil_filter }}&statut={{ statut_filter }}&departement={{ departement_filter }}&source={{ source_filter }}&actif={{ actif_filter }}&sort={{ sort_by }}&per_page={{ per_page }}">
            {{ num }}
          </a>
        </li>
        {% endif %}
      {% endfor %}
      
      {% if users.has_next %}
      <li>
        <a href="?page={{ users.next_page_number }}&search={{ search_query }}&type_profil={{ type_profil_filter }}&statut={{ statut_filter }}&departement={{ departement_filter }}&source={{ source_filter }}&actif={{ actif_filter }}&sort={{ sort_by }}&per_page={{ per_page }}">
          <i class="fas fa-angle-right"></i>
        </a>
      </li>
      <li>
        <a href="?page={{ users.paginator.num_pages }}&search={{ search_query }}&type_profil={{ type_profil_filter }}&statut={{ statut_filter }}&departement={{ departement_filter }}&source={{ source_filter }}&actif={{ actif_filter }}&sort={{ sort_by }}&per_page={{ per_page }}">
          <i class="fas fa-angle-double-right"></i>
        </a>
      </li>
      {% else %}
      <li class="disabled"><span><i class="fas fa-angle-right"></i></span></li>
      <li class="disabled"><span><i class="fas fa-angle-double-right"></i></span></li>
      {% endif %}
    </ul>
  </div>
  
  {% else %}
  <div class="empty-state">
    <i class="fas fa-users-slash"></i>
    <h3>Aucun utilisateur trouv√©</h3>
    <p>
      {% if search_query or type_profil_filter or statut_filter or departement_filter %}
      Essayez de modifier vos crit√®res de recherche
      {% else %}
      Commencez par ajouter des utilisateurs
      {% endif %}
    </p>
    <a href="{% url 'ajouter_superutilisateur' %}" class="btn btn-primary" style="margin-top: 1rem;">
      <i class="fas fa-user-plus"></i>
      Ajouter un utilisateur
    </a>
  </div>
  {% endif %}
</div>

<!-- Modal D√©tails utilisateur -->
<div class="modal-overlay" id="userDetailModal">
  <div class="modal">
    <div class="modal-header">
      <h3><i class="fas fa-user"></i> <span id="modalUserName">D√©tails utilisateur</span></h3>
      <button class="modal-close" onclick="closeModal('userDetailModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid" id="userDetailContent">
        <!-- Contenu charg√© dynamiquement -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('userDetailModal')">Fermer</button>
    </div>
  </div>
</div>

<!-- Modal Reset Password -->
<div class="modal-overlay" id="resetPasswordModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h3><i class="fas fa-key"></i> R√©initialiser le mot de passe</h3>
      <button class="modal-close" onclick="closeModal('resetPasswordModal')">&times;</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 1rem;">Nouveau mot de passe pour <strong id="resetUserName"></strong></p>
      <input type="hidden" id="resetUserId">
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nouveau mot de passe</label>
        <input type="password" id="newPassword" class="filter-select" style="width: 100%;" 
               placeholder="Minimum 8 caract√®res" minlength="8">
      </div>
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Confirmer</label>
        <input type="password" id="confirmPassword" class="filter-select" style="width: 100%;" 
               placeholder="Confirmer le mot de passe">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('resetPasswordModal')">Annuler</button>
      <button class="btn btn-primary" onclick="submitResetPassword()">
        <i class="fas fa-save"></i> R√©initialiser
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Fonctions utilitaires
function showModal(modalId) {
  document.getElementById(modalId).classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
  document.body.style.overflow = '';
}

// Fermer modal avec Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.active').forEach(modal => {
      modal.classList.remove('active');
    });
    document.body.style.overflow = '';
  }
});

// Fermer modal en cliquant sur l'overlay
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', function(e) {
    if (e.target === this) {
      this.classList.remove('active');
      document.body.style.overflow = '';
    }
  });
});

// Afficher les d√©tails d'un utilisateur
function showUserDetail(userId) {
  fetch(`{% url 'user_detail_ajax' 0 %}`.replace('0', userId))
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const user = data.user;
        document.getElementById('modalUserName').textContent = user.nom_complet;
        
        let html = `
          <div class="detail-item">
            <div class="detail-label">Matricule</div>
            <div class="detail-value">${user.matricule}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Nom d'utilisateur</div>
            <div class="detail-value">${user.username}</div>
          </div>
          <div class="detail-item full-width">
            <div class="detail-label">Email</div>
            <div class="detail-value">${user.email}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Type de profil</div>
            <div class="detail-value">${user.type_profil}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Statut employ√©</div>
            <div class="detail-value">${user.statut_employe}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">D√©partement</div>
            <div class="detail-value">${user.departement}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Site</div>
            <div class="detail-value">${user.site}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Poste</div>
            <div class="detail-value">${user.poste}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Manager</div>
            <div class="detail-value">${user.manager}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Date d'embauche</div>
            <div class="detail-value">${user.date_embauche}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Source</div>
            <div class="detail-value">
              <span class="badge ${user.source === 'Kelio' ? 'badge-kelio' : 'badge-local'}">
                ${user.source}
              </span>
            </div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Super administrateur</div>
            <div class="detail-value">${user.is_superuser ? '‚úÖ Oui' : '‚ùå Non'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Statut</div>
            <div class="detail-value">${user.actif ? 'üü¢ Actif' : 'üî¥ Inactif'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Derni√®re sync Kelio</div>
            <div class="detail-value">${user.kelio_last_sync}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Badge Kelio</div>
            <div class="detail-value">${user.kelio_badge_code}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Cr√©√© le</div>
            <div class="detail-value">${user.created_at}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Modifi√© le</div>
            <div class="detail-value">${user.updated_at}</div>
          </div>
        `;
        
        document.getElementById('userDetailContent').innerHTML = html;
        showModal('userDetailModal');
      } else {
        showNotification('Erreur: ' + data.message, 'error');
      }
    })
    .catch(error => {
      console.error('Erreur:', error);
      showNotification('Erreur de chargement', 'error');
    });
}

// Toggle actif/inactif
function toggleUserActif(userId, currentStatus) {
  const action = currentStatus ? 'd√©sactiver' : 'activer';
  
  if (!confirm(`Voulez-vous vraiment ${action} cet utilisateur ?`)) {
    return;
  }
  
  fetch(`{% url 'toggle_user_actif' 0 %}`.replace('0', userId), {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification(data.message, 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      showNotification('Erreur: ' + data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Erreur:', error);
    showNotification('Erreur de communication', 'error');
  });
}

// Reset password
function showResetPassword(userId, userName) {
  document.getElementById('resetUserId').value = userId;
  document.getElementById('resetUserName').textContent = userName;
  document.getElementById('newPassword').value = '';
  document.getElementById('confirmPassword').value = '';
  showModal('resetPasswordModal');
}

function submitResetPassword() {
  const userId = document.getElementById('resetUserId').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  if (newPassword.length < 8) {
    showNotification('Le mot de passe doit contenir au moins 8 caract√®res', 'error');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    showNotification('Les mots de passe ne correspondent pas', 'error');
    return;
  }
  
  const formData = new FormData();
  formData.append('new_password', newPassword);
  
  fetch(`{% url 'reset_user_password' 0 %}`.replace('0', userId), {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification(data.message, 'success');
      closeModal('resetPasswordModal');
    } else {
      showNotification('Erreur: ' + data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Erreur:', error);
    showNotification('Erreur de communication', 'error');
  });
}

// Recherche avec d√©lai
let searchTimeout;
document.querySelector('.search-box input').addEventListener('input', function() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    document.getElementById('filterForm').submit();
  }, 500);
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
  console.log('Page gestion utilisateurs charg√©e');
});
</script>
{% endblock %}